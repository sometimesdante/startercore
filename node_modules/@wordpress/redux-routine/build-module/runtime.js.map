{"version":3,"sources":["@wordpress/redux-routine/src/runtime.ts"],"names":["create","isPromise","isActionOfType","isAction","createRuntime","controls","dispatch","rungenControls","Object","entries","map","actionType","control","value","next","iterate","yieldNext","yieldError","routine","then","unhandledActionControl","push","rungenRuntime","action","Promise","resolve","reject","result"],"mappings":"AAAA;AACA;AACA;AACA,SAASA,MAAT,QAAgC,QAAhC;AACA,OAAOC,SAAP,MAAsB,YAAtB;;AAGA;AACA;AACA;AACA,SAASC,cAAT,EAAyBC,QAAzB,QAAyC,aAAzC;AAEA;AACA;AACA;AACA;AACA;AACA;;AACA,eAAe,SAASC,aAAT,GAMb;AAAA,MALDC,QAKC,uEAFG,EAEH;AAAA,MADDC,QACC;AACD,QAAMC,cAAc,GAAGC,MAAM,CAACC,OAAP,CAAgBJ,QAAhB,EAA2BK,GAA3B,CACtB;AAAA,QAAE,CAAEC,UAAF,EAAcC,OAAd,CAAF;AAAA,WACC,CAAEC,KAAF,EAASC,IAAT,EAAeC,OAAf,EAAwBC,SAAxB,EAAmCC,UAAnC,KAAmD;AAClD,UAAK,CAAEf,cAAc,CAAEW,KAAF,EAASF,UAAT,CAArB,EAA6C;AAC5C,eAAO,KAAP;AACA;;AACD,YAAMO,OAAO,GAAGN,OAAO,CAAEC,KAAF,CAAvB;;AACA,UAAKZ,SAAS,CAAEiB,OAAF,CAAd,EAA4B;AAC3B;AACAA,QAAAA,OAAO,CAACC,IAAR,CAAcH,SAAd,EAAyBC,UAAzB;AACA,OAHD,MAGO;AACND,QAAAA,SAAS,CAAEE,OAAF,CAAT;AACA;;AACD,aAAO,IAAP;AACA,KAbF;AAAA,GADsB,CAAvB;;AAiBA,QAAME,sBAAsB,GAAG,CAC9BP,KAD8B,EAE9BC,IAF8B,KAG1B;AACJ,QAAK,CAAEX,QAAQ,CAAEU,KAAF,CAAf,EAA2B;AAC1B,aAAO,KAAP;AACA;;AACDP,IAAAA,QAAQ,CAAEO,KAAF,CAAR;AACAC,IAAAA,IAAI;AACJ,WAAO,IAAP;AACA,GAVD;;AAWAP,EAAAA,cAAc,CAACc,IAAf,CAAqBD,sBAArB;AAEA,QAAME,aAAa,GAAGtB,MAAM,CAAEO,cAAF,CAA5B;AAEA,SAASgB,MAAF,IACN,IAAIC,OAAJ,CAAa,CAAEC,OAAF,EAAWC,MAAX,KACZJ,aAAa,CACZC,MADY,EAEVI,MAAF,IAAc;AACb,QAAKxB,QAAQ,CAAEwB,MAAF,CAAb,EAA0B;AACzBrB,MAAAA,QAAQ,CAAEqB,MAAF,CAAR;AACA;;AACDF,IAAAA,OAAO,CAAEE,MAAF,CAAP;AACA,GAPW,EAQZD,MARY,CADd,CADD;AAaA","sourcesContent":["/**\n * External dependencies\n */\nimport { create, Control } from 'rungen';\nimport isPromise from 'is-promise';\nimport type { Dispatch, AnyAction } from 'redux';\n\n/**\n * Internal dependencies\n */\nimport { isActionOfType, isAction } from './is-action';\n\n/**\n * Create a co-routine runtime.\n *\n * @param  controls Object of control handlers.\n * @param  dispatch Unhandled action dispatch.\n */\nexport default function createRuntime(\n\tcontrols: Record<\n\t\tstring,\n\t\t( value: any ) => Promise< boolean > | boolean\n\t> = {},\n\tdispatch: Dispatch\n) {\n\tconst rungenControls = Object.entries( controls ).map(\n\t\t( [ actionType, control ] ): Control =>\n\t\t\t( value, next, iterate, yieldNext, yieldError ) => {\n\t\t\t\tif ( ! isActionOfType( value, actionType ) ) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tconst routine = control( value );\n\t\t\t\tif ( isPromise( routine ) ) {\n\t\t\t\t\t// Async control routine awaits resolution.\n\t\t\t\t\troutine.then( yieldNext, yieldError );\n\t\t\t\t} else {\n\t\t\t\t\tyieldNext( routine );\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t}\n\t);\n\n\tconst unhandledActionControl = (\n\t\tvalue: AnyAction | unknown,\n\t\tnext: () => void\n\t) => {\n\t\tif ( ! isAction( value ) ) {\n\t\t\treturn false;\n\t\t}\n\t\tdispatch( value );\n\t\tnext();\n\t\treturn true;\n\t};\n\trungenControls.push( unhandledActionControl );\n\n\tconst rungenRuntime = create( rungenControls );\n\n\treturn ( action: AnyAction | Generator ) =>\n\t\tnew Promise( ( resolve, reject ) =>\n\t\t\trungenRuntime(\n\t\t\t\taction,\n\t\t\t\t( result ) => {\n\t\t\t\t\tif ( isAction( result ) ) {\n\t\t\t\t\t\tdispatch( result );\n\t\t\t\t\t}\n\t\t\t\t\tresolve( result );\n\t\t\t\t},\n\t\t\t\treject\n\t\t\t)\n\t\t);\n}\n"]}